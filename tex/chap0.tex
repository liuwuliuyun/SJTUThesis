\chapter{绪论}

\section{设计背景和应用场景}

模糊搜索是一类搜索相同或相似数据的搜索方法。大规模人脸数据的模糊搜索，指的是给定人脸数据返回其在大规模数据集中多个可能匹配项的过程，是人脸识别系统的核心。其实现涉及人脸检测，特征提取与向量匹配三方面。

而本文中的人脸识别系统为无感知条件下的人脸识别系统。其中无感知条件，指的是不依赖于用户主动配合即可完成人脸检测和识别的系统。而目前常见的人脸识别系统在使用时往往需要用户主动配合，如需要用户将面部对准摄像设备的中心区域，或者需要用户调整特定的角度以获得多角度的人脸信息。

无感知人脸识别有丰富的实际应用，其中最典型的应用场景有三个。

第一是教室点名。目前课堂点名的主要的方法有签到和教师口头点名两种方式，但是这两种方式都有很大的缺陷。首先，在大学课堂这种学生流动性较大的场景，教师很难记住每个学生的长相和姓名，如果一名学生实际未到，而请其他同学代为签到或者口头答道，教师很难分辨。其次，课堂时间是有限而宝贵的，如果同一课堂的人数较多，签到点名的时间是不可接受的。最后，签到点名无法调查学生在课堂上的学习状况。于此相比，使用无感知人脸识别系统不仅可以节约签到点名的时间，而且可以避免作弊现象。如果可以引入一些衡量标准例如学生的抬头率，抬头听课的时间等，则还可以调查学生在课堂上的学习状况，方便学校和教师调整教学策略。

第二是公司签到。目前已经有部分公司采用了人脸识别系统进行打卡签到，但是这种方法依然存在一些不足。这类打卡签到系统需要每一位员工使用打卡机，而当上下班高峰期时，会有非常多员工同时使用打卡机，从而需要排队等待。而使用无感知人脸检测则不仅可以避免排队等待，而且可以实时的掌握公司内部的人员信息。

第三是展会安保。大型展会和演出往往伴随者大量的人流，对集中出现的大量人流使用有感知的人脸检测逐一排查不仅耗时长，还容易加剧现场的拥堵现象。而监控室的工作人员也无法做到同时监控多路摄像头获取的视频数据。此时使用无感知人脸检测系统不仅可以避免现场的拥堵，而且可以做到实时筛选可能造成危险的人员，减轻会场安保系统的负担。

\section{研究的现状和研究成果}

\subsection{人脸的检测与特征提取}

人脸检测是指将人脸图像区域从一张图片中标注出来的过程。由于不同图片中人脸的姿势、大小和光照条件完全不同，使得这一过程非常具有挑战性。

早期的想法是请专家设计一些特征分类器，然后将一张图片的每一块区域都使用特征分类器进行分类，进而区分出人脸区域和非人脸区域。而这种人工设计分类器的分类效果并不能令人满意，因此研究者们开始利用机器学习的算法来训练分类器。这种方法首先需要寻找一类区分度强的，而且不易被光照强度等外界环境干扰的特征。然后将某一个训练数据集的图片分为含有人脸和不含人脸两种集合，分别从两种集合上提取某类特征。最后将区分效果较好的特征组合起来，得到完整的人脸特征分类器。使用的时候，将图片的每一个区域使用特征分类器进行分类，将分类的结果组合后得到图片中的人脸区域。

经过机器学习得到的分类器比起人工设计的分类器效果更好，其中的代表有基于HAAR特征级联分类器\cite{viola2004robust}和基于HOG特征的分类器\cite{dalal2005histograms}。这两种分类器直到现在依然在一些计算机视觉的开源工具包中被使用。

随着时间的推移，深度学习在计算机视觉领域开始大放异彩。由于深度神经网络有着非常强的表征能力和学习能力，使用深度学习的人脸检测算法在检测精度上迅速超过了传统的方法。其中具有代表性的基础网络结构包括VGG系列网络\cite{simonyan2014very}，ResNets系列网络\cite{he2016deep}等。而基于这些网络，研究者们针对不同场景下不同大小的人脸不断进行优化，在提升精度的同时提升运算速度，训练出了非常高效的人脸检测器。而我们尤其关注针对小脸检测进行优化的检测器，其代表为SSH检测器\cite{najibi2017ssh}和Tiny face检测器\cite{hu2017finding}。

关注这两个基于卷积神经网络的检测器是因为它们在非受控环境下的人脸检测测试集上取得了非常好的测试结果。我们希望通过实验来探究这两个检测器在无感知的人脸检测环境下是否依然有足够高的召回率与较低的计算代价。

人脸检测技术的飞速发展的同时，研究者们为了衡量算法的优劣，建立了多个公开的数据集。其中有代表性的有LFW数据集\cite{huang2007labeled}、WIDER FACE数据集\cite{yang2016wider}等。这些数据集中大多会区分训练集和测试集两种子集。其中WIDER FACE数据集还包括了人脸大小、姿势、遮挡、表情、妆容、光照条件等标记，被许多人脸检测算法广泛使用。而这些数据集中，并没有针对无感知人脸检测所设计的数据集。因此，我们自己建立了符合无感知人脸检测这一应用场景的数据集CFDDB。

在这个数据集中，我们使用了从教室摄像头获取的人脸图像，以期最接近实际使用场景。同时请几位志愿者进行人工标注并纠错，确保数据集中标记的准确性。同时我们在设计时充分考虑了数据集的可扩展性，使得数据集中的标记内容可以非常容易的获得扩充。

目前数据集的规模并不大，作为训练集使用容易出现过拟合等现象。因此我们将整个数据集用作测试集，并定义了测试人脸检测算法的多种参数，以衡量不同的人脸检测算法在执行无感知人脸检测时的优劣。

通常而言，检测出来的人脸区域并不能直接用于识别。为了保证识别的准确性，普遍的做法时找到检测算法得到的人脸区域的多个特征点，然后根据特征点的位置对人脸进行姿势校正。MtCNN网络\cite{zhang2016joint}不仅能够用于人脸的检测，而且在同时可以识别出人脸的多个特征点，被广泛地运用于人脸姿势的校正中。

特征提取的过程在这里被定义为从检测到的人脸区域产生人脸特征向量的过程。产生人脸特征向量的方法多种多样，其中使用深度网络提取人脸特征的InsightFace\cite{deng2018arcface}具有极高的精确性，在一些公开测试集上的精度达到了世界先进水平。

\subsection{人脸特征向量的匹配}

特征提取的结果为从人脸图像区域提取出的特征向量，想要将人脸与身份绑定，则需要匹配数据库中的人脸特征与检测得到的人脸特征。而根据实际应用场景的不同，数据库中的数据会有不同的规模。

针对小规模数据，线性搜索和多类支持向量机就有较好的匹配效果。而匹配大规模数据则需要依靠近似搜索的方法，以牺牲一定的精度与空间为代价获取较高的搜索效率。

目前广泛使用的近似搜索算法有基于有向图、基于kNN图、基于局部敏感哈希和基于矢量量化等多种类型的方法，本文主要分析基于局部敏感哈希和基于有向图的两种算法。

基于局部敏感哈希的算法需要用到LSH函数族，其中的每一个哈希函数都具有两种特征。一是有较高的概率将距离较近的向量映射到相同的桶中。二是有较低的概率将距离较远的向量映射到相同的桶中。利用这种特征，可以在人脸数据库中找到与输入特征向量相近的所有距离较近的向量，将问题转化为小规模数据的匹配。

基于有向图的算法首先会构建一张邻近图，从起始点出发沿着有向边行走。接着每走一步，都将缩减与查询点的距离。最终在行走有限步后找到距查询点最邻近的数据点。

\section{设计思路}

在无感知条件下，人脸信息的获取主要依赖于监控摄像头提供的视频流。由于不依赖于用户的主动配合，从视频流中抽取到的人脸区域往往是大角度、有遮挡的。如果使用全景视频流，人脸区域往往非常小，一帧图片中含有的人脸数目往往较多。为了解决这些问题，我们采用了以下方法：

首先是频繁地从视频流中截取关键帧，这样做的目的是保证我们从视频流中提取足够的样本，从而最大限度的减少人脸的漏检。而这种方法则对后端服务器会产生极大的压力，不仅要求服务器的带宽足够支持上千路图像的不间断输入，而且要求在服务器上运行的算法速度足够快从而保证等待队列不会溢出。

其次需要选择优秀的人脸检测算法，在计算效率足够高的同时保证能够对大角度、有遮挡的人脸有较高的检测效率并尽量避免将非人脸图像区域误判为人脸区域。

再次需要选择优秀的特征提取算法，在人脸图像区域不完整、有噪声的情况下能够准确快速的提取人脸的特征，并同数据库进行交互判断人脸身份。

最后需要摄像头不仅能够提供全景的图像信息，而且能够以某一预先设定好的顺序将某个固定空间分割成多个子空间提供每个子空间的视频流。

针对大规模人脸数据库，还需要考虑使用怎样的近似搜索算法快速在数据库中匹配人脸特征。

\section{设计工具}

在计算机视觉领域的发展过程中，很多优秀的工程师开发了丰富的开源工具，其中应用最为广泛的就是OpenCV\cite{opencv_library}。OpenCV功能强大，已经将图片读写、图片格式转换、HAAR特征级联分类器等常用功能封装成类或者类函数，而且底层使用C++实现，有着优秀的计算性能。于此同时，其还实现了Python脚本语言的调用接口，简单易用，因此被本系统的图像处理部分使用。

目前多数利用深度神经网络的算法需要一定的框架支持，而本系统中使用了Caffe\cite{jia2014caffe}和TensorFlow\cite{tensorflow2015-whitepaper}两种开源框架。

Caffe由Berkeley Vision and Learning Center和众多社区贡献者共同开发，以表达式、速度和模块化为核心的深度学习框架。本系统中使用卷积神经网络的SSH检测器就使用了这种开源框架。由于Caffe支持使用GPU加速，使得SSH检测器的时间性能大大提升。但是Caffe缺乏一套成熟的部署方案而且对嵌入式设备的支持力度较小，给系统的架构设计带来了一定的限制。

TensorFlow最早是由Google Brain团队开发的一个使用数据流图进行数值计算的深度学习开源框架。TensorFlow以数据流图作为核心，图中的节点代表数学运算，而图中的边则代表在这些节点之间传递的多维数组。本系统中MtCNN\cite{zhang2016joint}、Tiny face检测器\cite{hu2017finding}与InsightFace\cite{deng2018arcface}均使用了这种框架。TensorFlow支持使用GPU进行加速运算，同时支持使用TFserving和Docker容器进行规模化部署和更新。针对嵌入式设备，TensorFlow提供了TensorFlow Lite优化深度网络在移动设备、嵌入式设备上的运行效率。使用TensorFlow框架，不仅提升了运算速度，而且为系统的架构设计和部署都带来了很大的方便。

深度学习框架进行运算加速往往依赖于GPU，而我们在这个系统中使用了Nvidia公司开发的通用并行计算架构CUDA\cite{nickolls2008scalable}。这个架构赋予了GPU解决复杂计算问题的能力，尤其是图像处理中常见的矩阵运算，因此提高了整个系统的运算效率。

CuDNN\cite{chetlur2014cudnn}是Nvidia公司推出的针对深度神经网络的GPU加速库，Caffe和TensorFlow等深度学习框架的加速都依赖于它。CuDNN对常见的深度神经网络中的操作使用CUDA进行了精细优化，使得研究者们可以专心构建网络而不用花费大量时间优化网络。

\section{研究内容与主要工作}

研究工作主要分为四个阶段，每阶段的主要研究内容和成果如下：

\subsection{数据集设计与标注}

这一阶段共有五项研究内容。第一，根据无感知人脸识别的场景，从监控数据中抽样，得到测试集图片。第二，标注每一张图片的人脸位置与人脸标签并对标注进行纠错和预处理。第三，建立测试集CFDDB，分析CFDDB中的人脸属性，定义合理的测试参数，制定人脸检测算法的测试策略。第四，建立人脸特征向量数据库，制定人脸识别算法的测试策略。第五，分析改进CFDDB的方法，设计扩充CFDDB的流程。

完成这一阶段的研究工作后，我们发现CFDDB中的非正脸图像占比超过$70\%$，有遮挡人脸占比接近$60\%$，这给后续优化人脸检测与识别算法带来了极大的挑战。

\subsection{人脸检测与特征提取算法的测试与调参}

这一阶段共有五项研究内容。第一，封装基于HAAR特征的级联分类器\cite{viola2004robust}，实现基于CFDDB的测试接口，并根据召回率与时间效率分析其性能。第二，封装MtCNN\cite{zhang2016joint}，使用GPU服务器对其进行加速，并根据其深度网络的结构与功能分析其性能。第三，测试SSH检测器\cite{najibi2017ssh}，实现基于CFDDB的测试接口，并进行参数调优。第四，测试Tiny face检测器\cite{hu2017finding}，实现基于CFDDB的测试接口，并于SSH检测器调优后的结果进行对比。第五，测试高精度的特征提取算法InsightFace\cite{deng2018arcface}，确保其在CFDDB上有较高的召回率。

完成本阶段工作后，我们取得了如下三点研究成果。首先，基于HAAR特征的级联分类器与MtCNN召回率过低，不符合要求。其次，Tiny face检测器时间效率过低，不符合要求。最后，即使不考虑时间效率，SSH检测器在综合考虑召回率与误判率的条件下依然优于Tiny face检测器，因此选择SSH检测器作为人脸检测模块的核心算法。

\subsection{匹配算法的设计与优化}

这一阶段共有两项研究内容。第一，设计小规模数据集的匹配算法，分析其时间效率与空间效率。第二，设计大规模数据集的匹配算法，选择合理的优化策略。我们发现，在小规模数据集上利用人脸特征向量的性质，使用线性搜索或多类支持向量机都可以获得较好的匹配效果。而如果数据规模过大，则可以考虑使用基于多探针的局部敏感哈希与基于有向图的近似搜索算法进行高维向量匹配。

\subsection{无感知人脸识别系统的架构设计}

这一阶段的研究内容主要是设计良好的系统架构，保证系统高效稳定运行的同时具有可扩展的特性。在本阶段，我们设计了系统的数据处理流程、设备网络拓扑结构与逻辑架构，并在GPU服务器上实现了无感知人脸识别系统。
